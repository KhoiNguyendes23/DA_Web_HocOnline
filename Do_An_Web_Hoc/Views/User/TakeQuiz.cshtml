@{
    Layout = "~/Views/Shared/_LayoutUsers.cshtml";
    ViewData["Title"] = "Làm bài kiểm tra";

    var selectedQuiz = ViewBag.Quiz as Do_An_Web_Hoc.Models.Quizzes;
    var questions = ViewBag.Questions as List<Do_An_Web_Hoc.Models.Questions>;
    var answers = ViewBag.Answers as List<Do_An_Web_Hoc.Models.Answers>;
    var duration = ViewBag.Duration ?? 60;
}

<div class="container mt-4">
    <h3 class="text-center text-primary mb-4">📝 Làm bài kiểm tra</h3>

    @if (selectedQuiz != null && questions != null && questions.Any())
    {
        <form method="post" asp-action="SubmitQuiz" asp-controller="User" id="quizForm">
            <input type="hidden" name="QuizID" value="@selectedQuiz.QuizID" />
            <div class="text-danger text-end fw-bold mb-2" id="timer"></div>

            @for (int i = 0; i < questions.Count; i++)
            {
                var question = questions[i];
                var questionAnswers = answers.Where(a => a.QuestionID == question.QuestionID).ToList();

                <div class="mb-4 border p-3 rounded shadow-sm">
                    <h5 class="fw-bold">Câu @((i + 1)): @question.QuestionText</h5>

                    @if (question.QuestionType == "MCQ")
                    {
                        foreach (var answer in questionAnswers)
                        {
                            <div class="form-check">
                                <input type="radio"
                                       name="Question_@question.QuestionID"
                                       class="form-check-input"
                                       value="@answer.AnswerID"
                                       id="answer_@answer.AnswerID" />
                                <label class="form-check-label" for="answer_@answer.AnswerID">@answer.AnswerText</label>
                            </div>
                        }
                    }
                    else if (question.QuestionType == "Essay")
                    {
                        <textarea name="Question_@question.QuestionID"
                                  class="form-control mt-2"
                                  placeholder="Nhập câu trả lời..."
                                  rows="3"></textarea>
                    }
                </div>
            }

            <div class="text-center">
                <button type="button" class="btn btn-success" id="submitQuizBtn">Nộp bài</button>
                <a asp-action="QuizSelection" asp-controller="User" class="btn btn-secondary">Quay lại</a>
            </div>
        </form>
    }
    else
    {
        <div class="alert alert-warning">Không có câu hỏi nào cho bài kiểm tra này.</div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let seconds = @duration * 60;
        let timer = setInterval(function () {
            let min = Math.floor(seconds / 60);
            let sec = seconds % 60;
            document.getElementById("timer").innerText = `⏳ Còn lại: ${min} phút ${sec} giây`;
            seconds--;
            if (seconds < 0) {
                clearInterval(timer);
                Swal.fire({
                    icon: 'warning',
                    title: '⏰ Hết giờ!',
                    text: 'Bài kiểm tra sẽ được nộp ngay bây giờ.',
                    confirmButtonText: 'OK'
                }).then(() => {
                    document.getElementById("quizForm").submit();
                });
            }
        }, 1000);

        document.getElementById("submitQuizBtn").addEventListener("click", function () {
            Swal.fire({
                title: 'Bạn có chắc muốn nộp bài?',
                text: "Sau khi nộp, bạn sẽ không thể thay đổi câu trả lời.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Nộp bài',
                cancelButtonText: 'Hủy',
                confirmButtonColor: '#198754',
                cancelButtonColor: '#6c757d'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById("quizForm").submit();
                }
            });
        });
    </script>
}
