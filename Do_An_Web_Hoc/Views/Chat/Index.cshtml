@{
    Layout = "_LayoutAdmin"; // hoặc "_LayoutLecturer" tùy người dùng đăng nhập
    var userId = ViewBag.CurrentUserId;
}

<h3>💬 Chat Realtime</h3>

<!-- Chọn người để chat -->
<select id="receiverSelect" class="form-select mb-3">
    @foreach (var user in ViewBag.Users)
    {
        <option value="@user.UserID">@user.FullName (@user.RoleID)</option>
    }
</select>

<!-- Vùng hiển thị tin nhắn -->
<div id="chat-messages" style="border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto;"></div>

<!-- Input gửi tin -->
<div class="input-group mt-2">
    <input type="text" id="chat-input" class="form-control" placeholder="Nhập tin nhắn..." />
    <button id="chat-send" class="btn btn-primary">Gửi</button>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder().withUrl("/chathub").build();

        connection.start().then(() => {
            console.log("✅ SignalR connected");
        }).catch(err => console.error(err.toString()));

        const senderId = @userId;

        document.getElementById("chat-send").addEventListener("click", function () {
            const message = document.getElementById("chat-input").value.trim();
            const receiverId = document.getElementById("receiverSelect").value;

            if (!message || !receiverId) return;

            connection.invoke("SendMessage", senderId, receiverId, message)
                .catch(err => console.error(err.toString()));

            // Hiển thị tin ngay trên khung chat
            const container = document.getElementById("chat-messages");
            container.innerHTML += `<div class="text-end text-primary"><b>Bạn:</b> ${message}</div>`;
            container.scrollTop = container.scrollHeight;

            document.getElementById("chat-input").value = "";
        });

        // Nhận tin nhắn realtime
        connection.on("ReceiveMessage", function (senderId, message) {
            const container = document.getElementById("chat-messages");
            container.innerHTML += `<div class="text-start"><b>Người gửi:</b> ${message}</div>`;
            container.scrollTop = container.scrollHeight;
        });
    </script>
}
